<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Guide de DÃ©pannage â€” CamÃ©ra</title>
<style>
    :root{
      --bg:#0f172a;/*slate-900*/
      --card:#111827;/*gray-900*/
      --fg:#e5e7eb;/*gray-200*/
      --muted:#9ca3af;/*gray-400*/
      --accent:#60a5fa;/*blue-400*/
      --ok:#22c55e;/*green-500*/
      --ko:#ef4444;/*red-500*/
      --warn:#f59e0b;/*amber-500*/
      --chip:#1f2937;/*gray-800*/
      --line:#374151;/*gray-700*/
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,0));backdrop-filter:blur(6px);z-index:50;padding:12px 16px}
    header h1{margin:0;font-size:19px}
    header small{color:var(--muted)}
    main{padding:12px 12px 96px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button, .btn{
      appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--fg);
      padding:10px 12px;border-radius:12px;font-weight:600;font-size:15px;cursor:pointer
    }
    button:active{transform:scale(.98)}
    .btn-chip{background:var(--chip);border:1px solid var(--line);font-size:13px;padding:6px 10px;border-radius:999px;color:var(--muted)}
    .ok{border-color:#14532d;background:#052e16;color:#86efac}
    .ko{border-color:#7f1d1d;background:#450a0a;color:#fca5a5}
    .warn{border-color:#78350f;background:#451a03;color:#fde68a}
    details{border:1px dashed var(--line);border-radius:12px;padding:10px;margin:8px 0}
    details[open]{border-style:solid}
    summary{cursor:pointer;font-weight:700;list-style:none}
    summary::-webkit-details-marker{display:none}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .label{font-size:13px;color:var(--muted)}
    input[type="text"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--fg)}
    textarea{min-height:72px}
    .sticky-bar{
      position:fixed;bottom:10px;left:10px;right:10px;display:flex;gap:8px;
      background:rgba(2,6,23,.8);backdrop-filter:blur(6px);padding:10px;border:1px solid var(--line);border-radius:14px;z-index:60
    }
    .pill{flex:1;text-align:center}
    .muted{color:var(--muted)}
    .hidden{display:none}
    #wizard-overlay.hidden { display: none; }
    .step-badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--line);color:var(--muted)}
    .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    .dot-ok{background:var(--ok)} .dot-ko{background:var(--ko)} .dot-warn{background:var(--warn)}
    .photo-preview{max-width:100%;border-radius:10px;border:1px solid var(--line);margin-top:8px}
    .spacer{height:6px}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    /* Flowchart styles */
    .flowchart{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding-top:10px}
    .flow-step{background:var(--accent);border:1px solid var(--accent);padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;text-align:center;color:var(--bg)}
    .flow-arrow{color:var(--accent);font-weight:bold;}
    /* Wizard overlay */
    #wizard-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:100;display:flex;align-items:center;justify-content:center;padding:16px}
    #wizard-card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;animation:fadein .25s ease}
    #wizard-card h3{margin:0 0 10px;font-size:18px;color:var(--accent)}
    #wizard-card p{margin:0 0 16px;color:var(--muted);min-height:40px}
    #wizard-answers{display:flex;flex-direction:column;gap:8px}
    #wizard-close{position:absolute;top:12px;right:12px}
    @keyframes fadein{from{opacity:0;transform:scale(.97)}}
  
/* === Hide top & bottom bubbles (no other changes) === */
.flowchart{display:none !important;}
.sticky-bar{display:none !important;}
</style>
</head>
<body>
<header>
<h1>Guide de DÃ©pannage â€” CamÃ©ra</h1>
<div class="flowchart">
<span class="flow-step">RÃ©ception Mail</span><span class="flow-arrow">â†’</span>
<span class="flow-step">Prise en compte JIRA</span><span class="flow-arrow">â†’</span>
<span class="flow-step">Intervention Site</span><span class="flow-arrow">â†’</span>
<span class="flow-step">Appel SIPPRO/CVU</span><span class="flow-arrow">â†’</span>
<span class="flow-step">Saisie Fiche</span><span class="flow-arrow">â†’</span>
<span class="flow-step">Ticket sur JIRA</span>
</div>
</header>
<main>
<div class="card" id="step-site">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>ArrivÃ©e sur site</strong>
</div>
<div class="spacer"></div><ul><li>Inspection visuelle de lâ€™Ã©quipement et de lâ€™environnement immÃ©diat.</li><li>Si lâ€™accÃ¨s nâ€™est pas possible, sâ€™il y a vandalisme ou autre anomalie : prendre des photos et les joindre Ã  la fiche dâ€™intervention (en dehors de ce guide).</li></ul></div>
<div class="card" id="step-alim">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Diagnostic Alimentation</strong>
<div class="row">
<button class="pill" id="startAlimDiag">ðŸ”Ž Assistant guidÃ©</button>
</div>
</div>
<div class="spacer"></div>
<div class="grid2">
<button class="pill ok" data-branch="alim-ok">Alim OK</button>
<button class="pill ko" data-branch="alim-ko">Alim KO</button>
</div>
<details>
<summary>Guidage rapide</summary>
<ul>
<li>VÃ©rifier disjoncteur / parafoudre</li>
<li>Mesure tension (230V / 12-24V / panneaux solaires)</li>
<li>CÃ¢bles / connexions</li>
</ul>
</details>
<div id="alim-branches"></div>
</div>
<div class="card" id="step-reseau">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Diagnostic RÃ©seau</strong>
<div class="row">
<button class="pill" id="startNetDiag">ðŸ”Ž Assistant guidÃ©</button>
</div>
</div>
<div class="spacer"></div>
<div class="grid2">
<button class="pill ok" data-branch="net-ok">RÃ©seau OK</button>
<button class="pill ko" data-branch="net-ko">RÃ©seau KO</button>
</div>
<details>
<summary>Guidage rapide</summary>
<ul>
<li>Ping / lien PoE / switch</li>
<li>Adressage / VLAN</li>
<li>Remise en lien</li>
</ul>
</details>
<div id="net-branches"></div>
</div>
<div class="card" id="step-materiel">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Diagnostic MatÃ©riel</strong>
<div class="row">
<button class="pill" id="startHwDiag">ðŸ”Ž Assistant guidÃ©</button>
</div>
</div>
<div class="spacer"></div>
<div class="grid2">
<button class="pill ok" data-branch="hw-ok">MatÃ©riel OK</button>
<button class="pill ko" data-branch="hw-ko">MatÃ©riel KO</button>
</div>
<details>
<summary>Guidage rapide</summary>
<ul>
<li>Test camÃ©ra / remplacement temporaire</li>
<li>Firmware / reset si nÃ©cessaire</li>
<li>Connectique / oxydation</li>
</ul>
</details>
<div id="hw-branches"></div>
</div>
</main>
<nav class="sticky-bar">
<button class="pill" data-go="#step-site">Site</button>
<button class="pill" data-go="#step-alim">Alim</button>
<button class="pill" data-go="#step-reseau">RÃ©seau</button>
<button class="pill" data-go="#step-materiel">MatÃ©riel</button>
</nav>
<div aria-live="polite" class="hidden" id="wizard-overlay">
<div id="wizard-card">
<button class="btn-chip" id="wizard-close">Fermer âœ•</button>
<h3 id="wizard-title">Diagnostic GuidÃ©</h3>
<p id="wizard-text">Chargementâ€¦</p>
<div id="wizard-answers"></div>
</div>
</div>
<script>
// ---------- Helpers ----------
const qs  = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
const store = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };
const load  = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e){ return d } };

// ---------- Checklist (tuto_) ----------
const checklist = load('fusion_checklist', {});
const checklistKeys = ['visuel','photos','resolu','devis'];
const checklistRow = qs('#checklistRow');
const percentEl = qs('#percent');

function renderChecklist(){
  if(!checklistRow || !percentEl){ return; }
checklistRow.innerHTML = '';
  let done = 0;
  checklistKeys.forEach(k => {
    const on = !!checklist[k];
    if(on) done++;
    const span = document.createElement('span');
    span.className = 'btn-chip';
    span.textContent = (on ? 'âœ” ' : 'â—‹ ') + k;
    span.onclick = () => {
      checklist[k] = !on;
      store('fusion_checklist', checklist);
      if (checklistRow && percentEl) renderChecklist();
    };
    checklistRow.appendChild(span);
  });
  const percent = Math.round((done / checklistKeys.length) * 100);
  percentEl.textContent = percent + '% terminÃ©';
}
if (checklistRow && percentEl) renderChecklist();

qsa('[data-check]').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-check');
    checklist[key] = !checklist[key];
    store('fusion_checklist', checklist);
    if (checklistRow && percentEl) renderChecklist();
  });
});

// ---------- Navigation ----------
qsa('[data-go]').forEach(el => el.addEventListener('click', e => {
  const target = el.getAttribute('data-go');
  const t = qs(target);
  if(t){ t.scrollIntoView({behavior:'smooth', block:'start'}); }
}));

// ---------- Photo preview ----------
const photoInput1 = qs('#photoInput1');
const photoPreviewContainer1 = qs('#photoPreviewContainer1');
if (photoInput1){
  photoInput1.addEventListener('change', (e) => {
    if (!photoPreviewContainer1) return;
    photoPreviewContainer1.innerHTML = '';
    [...e.target.files].forEach(file => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.className = 'photo-preview';
      photoPreviewContainer1.appendChild(img);
    });
  });
}

// ---------- Branching mini-guides (tuto_) ----------
const branchTexts = {
  'alim-ok': '<div class="muted">Alimentation OK â†’ passer au diagnostic RÃ©seau.</div>',
  'alim-ko': '<ul><li>VÃ©rifier disjoncteur (rÃ©armement)</li><li>Mesurer 230V ou 12/24V</li><li>Tester cÃ¢ble / connectique</li><li>Si pack batterie HS â†’ RMA ou Devis</li></ul>',
  'net-ok' : '<div class="muted">RÃ©seau OK â†’ passer au diagnostic MatÃ©riel.</div>',
  'net-ko' : '<ul><li>VÃ©rifier PoE / lien</li><li>Adressage IP / VLAN</li><li>Switch / SFP / jarretiÃ¨re</li></ul>',
  'hw-ok'  : '<div class="muted">MatÃ©riel OK â†’ si toujours panne, revoir rÃ©seau/alimentation.</div>',
  'hw-ko'  : '<ul><li>Tester avec camÃ©ra de secours</li><li>Reset / firmware</li><li>Oxydation / connecteurs</li><li>Si panne confirmÃ©e â†’ RMA ou Devis</li></ul>'
};
function mountBranch(containerId, key){
  const el = qs(containerId);
  if(!el) return;
  el.innerHTML = '<details open><summary>Chemin choisi</summary>' + branchTexts[key] + '</details>';
}
qsa('[data-branch]').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-branch');
    if(key.startsWith('alim')) mountBranch('#alim-branches', key);
    if(key.startsWith('net'))  mountBranch('#net-branches', key);
    if(key.startsWith('hw'))   mountBranch('#hw-branches', key);
  });
});


// ---------- Report export ----------
const __exp = qs('#exportBtn'); if(__exp){ __exp.addEventListener('click', () => {
  const lines = [];
  const date = new Date().toLocaleString('fr-FR');
  lines.push('Rapport de dÃ©pannage â€” ' + date);
  lines.push('');
  lines.push('Checklist:');
  checklistKeys.forEach(k => lines.push(`- ${k}: ${checklist[k] ? 'OK' : 'NON'}`));
  lines.push('');
  lines.push('Journal assistant guidÃ©:');
  const log = load('fusion_reportLog', []);
  log.forEach(l => lines.push(l));
  lines.push('');
  lines.push('Compte-rendu:');
  lines.push(qs('#cr').value || '(vide)');
  const text = lines.join('\n');
  const pre = qs('#export');
  pre.textContent = text;
  pre.classList.remove('hidden');
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'rapport_depannage.txt';
  a.click();
  URL.revokeObjectURL(url);
}); }

// =====================================================
// ============== Wizard (Dep3 amÃ©liorÃ©) ===============
// =====================================================
let fusion_reportLog = load('fusion_reportLog', []);
function logStep(text) {
  const timestamp = new Date().toLocaleTimeString('fr-FR');
  fusion_reportLog.push(`${timestamp} - ${text}`);
  store('fusion_reportLog', fusion_reportLog);
}

const diagSteps = {
  alim_main: {
    start: {
      title: 'Alimentation',
      text: 'Quel est le type d\'alimentation ?',
      answers: [
        { text: '230V', next: 'start', flow: 'alim_230v' },
        { text: 'Batterie / EP', next: 'start', flow: 'alim_batt' },
        { text: 'Panneaux Solaires', next: 'start', flow: 'alim_solar' }
      ]
    }
  },
  alim_230v: {
    start: {
      title: 'Alim 230V',
      text: 'VÃ©rifier le disjoncteur Ã©lectrique. Est-il enclenchÃ© ?',
      answers: [
        { text: 'Oui', next: 'tension_sortie' },
        { text: 'Non', next: 'reenclencher' }
      ]
    },
    reenclencher: {
      text: 'RÃ©-enclencher le disjoncteur. Tient-il ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Surcharge ponctuelle. ProblÃ¨me rÃ©solu.' },
        { text: 'Non', conclusion: 'KO - Court-circuit sur la ligne ou l\'Ã©quipement.' }
      ]
    },
    tension_sortie: {
      text: 'Mesurer la tension en sortie du disjoncteur. Tension de 230V prÃ©sente ?',
      answers: [
        { text: 'Oui', next: 'tension_equip' },
        { text: 'Non', conclusion: 'KO - ProblÃ¨me en amont du disjoncteur (rÃ©seau).' }
      ]
    },
    tension_equip: {
      text: 'Tension prÃ©sente sur l\'Ã©quipement ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - L\'alimentation est OK. Le problÃ¨me n\'est pas Ã©lectrique.' },
        { text: 'Non', conclusion: 'KO - ProblÃ¨me sur le cÃ¢ble ou mauvaise connexion.' }
      ]
    }
  },
  alim_batt: {
    start: {
      title: 'Alim Batterie',
      text: 'Mesurer la tension aux bornes de la batterie. Tension correcte (12V/24V) ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - L\'alimentation est OK. Le problÃ¨me n\'est pas Ã©lectrique.' },
        { text: 'Non', next: 'disj' }
      ]
    },
    disj: {
      text: 'VÃ©rifier Disjoncteur EP / Parafoudre. Quel est l\'Ã©tat ?',
      answers: [
        { text: 'OK', next: 'rechange_dispo' },
        { text: 'KO', conclusion: 'KO - Disjoncteur/Parafoudre Ã  remplacer.' }
      ]
    },
    rechange_dispo: {
      text: 'Batterie de rechange disponible dans le vÃ©hicule ?',
      answers: [
        { text: 'Oui', next: 'remplacer' },
        { text: 'Non', conclusion: 'KO - PrÃ©voir nouvelle intervention (pas de batterie).' }
      ]
    },
    remplacer: {
      text: 'Remplacer par une batterie pleine. Le chargeur fonctionne bien ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - ProblÃ¨me rÃ©solu (batterie remplacÃ©e).' },
        { text: 'Non', conclusion: 'KO - ProblÃ¨me du Pack, RMA Ã  prÃ©voir.' }
      ]
    }
  },
  alim_solar: {
    start: {
      title: 'Alim Solaire',
      text: 'Mesurer la tension aux bornes de la batterie. Tension correcte (~12V) ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Le systÃ¨me solaire est OK.' },
        { text: 'Non', next: 'panneaux' }
      ]
    },
    panneaux: {
      text: 'VÃ©rifier la tension en sortie des panneaux (en plein soleil). Correcte (>17V) ?',
      answers: [
        { text: 'Oui', next: 'regulateur' },
        { text: 'Non', conclusion: 'KO - ProblÃ¨me sur les panneaux (propretÃ©, ombrage, panne).' }
      ]
    },
    regulateur: {
      text: 'VÃ©rifier le rÃ©gulateur de charge. Fonctionne-t-il correctement ?',
      answers: [
        { text: 'Oui', conclusion: 'KO - La batterie est HS et n\'accepte plus la charge.' },
        { text: 'Non', conclusion: 'KO - RÃ©gulateur de charge dÃ©fectueux. Remplacement nÃ©cessaire.' }
      ]
    }
  },
  net: {
    start: {
      title: 'RÃ©seau',
      text: 'Le lien rÃ©seau (Switch, PoE) est-il actif ?',
      answers: [
        { text: 'Oui', next: 'ping' },
        { text: 'Non', conclusion: 'KO - Pas de lien physique. VÃ©rifier cÃ¢blage, switch, PoE.' }
      ]
    },
    ping: {
      text: 'La camÃ©ra rÃ©pond-elle au ping ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - La connectivitÃ© rÃ©seau semble OK.' },
        { text: 'Non', conclusion: 'KO - ProblÃ¨me de configuration IP, VLAN ou pare-feu.' }
      ]
    }
  },
  hw: {
    start: {
      title: 'MatÃ©riel',
      text: 'Tester la camÃ©ra en local. Fonctionne-t-elle ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Le problÃ¨me n\'est pas la camÃ©ra. Re-vÃ©rifier Alim/RÃ©seau.' },
        { text: 'Non', conclusion: 'KO - ProblÃ¨me sur la camÃ©ra, RMA ou devis Ã  prÃ©voir si le problÃ¨me n\'est pas rÃ©solu suite Ã  la rÃ©initialisation.' }
      ]
    }
  }
};

const wizardOverlay = qs('#wizard-overlay');
const wizardTitle = qs('#wizard-title');
const wizardText  = qs('#wizard-text');
const wizardAnswers = qs('#wizard-answers');
const wizardClose = qs('#wizard-close');

let currentFlow = null;
let currentFlowKey = null;

function startWizard(flowKey) {
  currentFlowKey = flowKey;
  currentFlow = diagSteps[flowKey];
  if (!currentFlow || !currentFlow.start) {
    console.error('Diagnostic flow not found or invalid:', flowKey);
    return;
  }
  wizardTitle.textContent = currentFlow.start.title || 'Diagnostic';
  wizardText.textContent = currentFlow.start.text || '...';
  wizardAnswers.innerHTML = '';
  wizardOverlay.classList.remove('hidden');
  logStep(`DEBUT Diagnostic: ${wizardTitle.textContent}`);
  setTimeout(() => renderStep('start'), 0);
}

function renderStep(stepKey) {
  const step = currentFlow[stepKey];
  if (!step) {
    console.error('Step not found:', stepKey, 'in', currentFlowKey);
    wizardText.textContent = 'Ã‰tape introuvable.';
    wizardAnswers.innerHTML = '<button class="pill" onclick="endWizard()">Fermer</button>';
    return;
  }
  wizardTitle.textContent = step.title || currentFlow.start.title || 'Diagnostic';
  wizardText.textContent  = step.text || step.conclusion || '';
  wizardAnswers.innerHTML = '';

  if (step.answers && step.answers.length) {
    step.answers.forEach(answer => {
      const btn = document.createElement('button');
      btn.textContent = answer.text;
      btn.className = 'pill';
      btn.onclick = () => {
        logStep(`${wizardText.textContent} -> ${answer.text}`);
        if (answer.flow) {
          currentFlowKey = answer.flow;
          currentFlow = diagSteps[answer.flow];
        }
        if (answer.next) {
            renderStep(answer.next);
        } else if (answer.conclusion) {
            renderConclusion(answer);
        } else {
            renderConclusion({ conclusion: 'Fin.' });
        }
      };
      wizardAnswers.appendChild(btn);
    });
  } else if (step.conclusion) {
    renderConclusion(step);
  } else {
    const btn = document.createElement('button');
    btn.textContent = 'Continuer';
    btn.className = 'pill';
    btn.onclick = endWizard;
    wizardAnswers.appendChild(btn);
  }
}

function renderConclusion(step) {
  wizardText.textContent = step.conclusion;
  wizardAnswers.innerHTML = '';
  const btn = document.createElement('button');
  btn.textContent = 'Terminer';
  btn.className = 'pill ok';
  btn.onclick = () => {
    logStep(`CONCLUSION: ${step.conclusion}`);
    endWizard();
  };
  wizardAnswers.appendChild(btn);
}

function endWizard() {
  wizardOverlay.classList.add('hidden');
  currentFlow = null;
  currentFlowKey = null;
}

wizardClose.addEventListener('click', endWizard);

// Triggers
qs('#startAlimDiag').addEventListener('click', () => startWizard('alim_main'));
qs('#startNetDiag').addEventListener('click',  () => startWizard('net'));
qs('#startHwDiag').addEventListener('click',   () => startWizard('hw'));

</script>
</body>
</html>
