<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Guide de D√©pannage ‚Äî Cam√©ra</title>
<style>
    :root{
      --bg:#1e6d67;/*slate-900*/
      --card:#111827;/*gray-900*/
      --fg:#e5e7eb;/*gray-200*/
      --muted:#9ca3af;/*gray-400*/
      --accent:#60a5fa;/*blue-400*/
      --ok:#22c55e;/*green-500*/
      --ko:#ef4444;/*red-500*/
      --warn:#f59e0b;/*amber-500*/
      --chip:#1f2937;/*gray-800*/
      --line:#374151;/*gray-700*/
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,0));backdrop-filter:blur(6px);z-index:50;padding:12px 16px}
    header h1{margin:0;font-size:19px}
    header small{color:var(--muted)}
    main{padding:12px 12px 96px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button, .btn{
      appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--fg);
      padding:10px 12px;border-radius:12px;font-weight:600;font-size:15px;cursor:pointer
    }
    button:active{transform:scale(.98)}
    .btn-chip{background:var(--chip);border:1px solid var(--line);font-size:13px;padding:6px 10px;border-radius:999px;color:var(--muted)}
    .ok{border-color:#14532d;background:#052e16;color:#86efac}
    .ko{border-color:#7f1d1d;background:#450a0a;color:#fca5a5}
    .warn{border-color:#78350f;background:#451a03;color:#fde68a}
    details{border:1px dashed var(--line);border-radius:12px;padding:10px;margin:8px 0}
    details[open]{border-style:solid}
    summary{cursor:pointer;font-weight:700;list-style:none}
    summary::-webkit-details-marker{display:none}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .label{font-size:13px;color:var(--muted)}
    input[type="text"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--fg)}
    textarea{min-height:72px}
    .sticky-bar{
      position:fixed;bottom:10px;left:10px;right:10px;display:flex;gap:8px;
      background:rgba(2,6,23,.8);backdrop-filter:blur(6px);padding:10px;border:1px solid var(--line);border-radius:14px;z-index:60
    }
    .pill{flex:1;text-align:center}
    .muted{color:var(--muted)}
    .hidden{display:none}
    #wizard-overlay.hidden { display: none; }
    .step-badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--line);color:var(--muted)}
    .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
    .dot-ok{background:var(--ok)} .dot-ko{background:var(--ko)} .dot-warn{background:var(--warn)}
    .photo-preview{max-width:100%;border-radius:10px;border:1px solid var(--line);margin-top:8px}
    .spacer{height:6px}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    /* Flowchart styles */
    .flowchart{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding-top:10px}
    .flow-step{background:var(--accent);border:1px solid var(--accent);padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;text-align:center;color:var(--bg)}
    .flow-arrow{color:var(--accent);font-weight:bold;}
    /* Wizard overlay */
    #wizard-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:100;display:flex;align-items:center;justify-content:center;padding:16px}
    #wizard-card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;animation:fadein .25s ease}
    #wizard-card h3{margin:0 0 10px;font-size:18px;color:var(--accent)}
    #wizard-card p{margin:0 0 16px;color:var(--muted);min-height:40px}
    #wizard-answers{display:flex;flex-direction:column;gap:8px}
    #wizard-close{position:absolute;top:12px;right:12px}
    @keyframes fadein{from{opacity:0;transform:scale(.97)}}
  
/* === Hide top & bottom bubbles (no other changes) === */
.flowchart{display:none !important;}
.sticky-bar{display:none !important;}
/* Mobile: all√©ger l'ent√™te et les espacements */
@media (max-width: 640px){
  header{position:static;padding:6px 8px;background:none}
  main{padding:8px 8px 12px}
  .card{margin:8px 0;padding:10px}
} 
.fs-btn{
  position:fixed;top:10px;right:10px;z-index:9999;
  background:var(--accent);color:#fff;border:0;border-radius:999px;
  padding:8px 12px;font-weight:700;box-shadow:0 6px 20px rgba(0,0,0,.25);cursor:pointer;
}
.fs-btn:hover{opacity:.9}
</style>
</head>
<body>
<header>
<a id="fsLink" class="fs-btn" href="#" target="_blank" rel="noopener">‚§¢ Plein √©cran</a>
</header>
<main>
<div class="card" id="step-site">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Arriv√©e sur site</strong>
</div>
<div class="spacer"></div><ul><li>Inspection visuelle de l‚Äô√©quipement et de l‚Äôenvironnement imm√©diat.</li><li>Si l‚Äôacc√®s n‚Äôest pas possible, s‚Äôil y a vandalisme ou autre anomalie : prendre des photos et les joindre √† la fiche d‚Äôintervention.</li></ul></div>
<div class="card" id="step-alim">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Diagnostic Alimentation</strong>
<div class="row">
<button class="pill" id="startAlimDiag">üîé Assistant guid√©</button>
</div>
</div>
<div class="spacer"></div>
<div class="grid2">
<button class="pill ok" data-branch="alim-ok">Alim OK</button>
<button class="pill ko" data-branch="alim-ko">Alim KO</button>
</div>
<details>
<summary>Guidage rapide</summary>
<ul>
<li>V√©rifier disjoncteur / parafoudre</li>
<li>Mesure tension (230V / 12-24V / panneaux solaires)</li>
<li>C√¢bles / connexions</li>
</ul>
</details>
<div id="alim-branches"></div>
</div>
<div class="card" id="step-reseau">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Diagnostic R√©seau</strong>
<div class="row">
<button class="pill" id="startNetDiag">üîé Assistant guid√©</button>
</div>
</div>
<div class="spacer"></div>
<div class="grid2">
<button class="pill ok" data-branch="net-ok">R√©seau OK</button>
<button class="pill ko" data-branch="net-ko">R√©seau KO</button>
</div>
<details>
<summary>Guidage rapide</summary>
<ul>
<li>Ping / lien PoE / switch</li>
<li>Adressage / VLAN</li>
<li>Remise en lien</li>
</ul>
</details>
<div id="net-branches"></div>
</div>
<div class="card" id="step-materiel">
<div class="row" style="justify-content:space-between;align-items:center">
<strong>Diagnostic Mat√©riel</strong>
<div class="row">
<button class="pill" id="startHwDiag">üîé Assistant guid√©</button>
</div>
</div>
<div class="spacer"></div>
<div class="grid2">
<button class="pill ok" data-branch="hw-ok">Mat√©riel OK</button>
<button class="pill ko" data-branch="hw-ko">Mat√©riel KO</button>
</div>
<details>
<summary>Guidage rapide</summary>
<ul>
<li>Test cam√©ra / remplacement temporaire</li>
<li>Firmware / reset si n√©cessaire</li>
<li>Connectique / oxydation</li>
</ul>
</details>
<div id="hw-branches"></div>
</div>
</main>
<nav class="sticky-bar">
<button class="pill" data-go="#step-site">Site</button>
<button class="pill" data-go="#step-alim">Alim</button>
<button class="pill" data-go="#step-reseau">R√©seau</button>
<button class="pill" data-go="#step-materiel">Mat√©riel</button>
</nav>
<div aria-live="polite" class="hidden" id="wizard-overlay">
<div id="wizard-card">
<button class="btn-chip" id="wizard-close">Fermer ‚úï</button>
<h3 id="wizard-title">Diagnostic Guid√©</h3>
<p id="wizard-text">Chargement‚Ä¶</p>
<div id="wizard-answers"></div>
</div>
</div>
<script>
// ---------- Helpers ----------
const qs  = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
const store = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };
const load  = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e){ return d } };

// ---------- Checklist (tuto_) ----------
const checklist = load('fusion_checklist', {});
const checklistKeys = ['visuel','photos','resolu','devis'];
const checklistRow = qs('#checklistRow');
const percentEl = qs('#percent');

function renderChecklist(){
  if(!checklistRow || !percentEl){ return; }
checklistRow.innerHTML = '';
  let done = 0;
  checklistKeys.forEach(k => {
    const on = !!checklist[k];
    if(on) done++;
    const span = document.createElement('span');
    span.className = 'btn-chip';
    span.textContent = (on ? '‚úî ' : '‚óã ') + k;
    span.onclick = () => {
      checklist[k] = !on;
      store('fusion_checklist', checklist);
      if (checklistRow && percentEl) renderChecklist();
    };
    checklistRow.appendChild(span);
  });
  const percent = Math.round((done / checklistKeys.length) * 100);
  percentEl.textContent = percent + '% termin√©';
}
if (checklistRow && percentEl) renderChecklist();

qsa('[data-check]').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-check');
    checklist[key] = !checklist[key];
    store('fusion_checklist', checklist);
    if (checklistRow && percentEl) renderChecklist();
  });
});

// ---------- Navigation ----------
qsa('[data-go]').forEach(el => el.addEventListener('click', e => {
  const target = el.getAttribute('data-go');
  const t = qs(target);
  if(t){ t.scrollIntoView({behavior:'smooth', block:'start'}); }
}));

// ---------- Photo preview ----------
const photoInput1 = qs('#photoInput1');
const photoPreviewContainer1 = qs('#photoPreviewContainer1');
if (photoInput1){
  photoInput1.addEventListener('change', (e) => {
    if (!photoPreviewContainer1) return;
    photoPreviewContainer1.innerHTML = '';
    [...e.target.files].forEach(file => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.className = 'photo-preview';
      photoPreviewContainer1.appendChild(img);
    });
  });
}

// ---------- Branching mini-guides (tuto_) ----------
const branchTexts = {
  'alim-ok': '<div class="muted">Alimentation OK ‚Üí passer au diagnostic R√©seau.</div>',
  'alim-ko': '<ul><li>V√©rifier disjoncteur (r√©armement)</li><li>Mesurer 230V ou 12/24V</li><li>Tester c√¢ble / connectique</li><li>Si pack batterie HS ‚Üí RMA ou Devis</li></ul>',
  'net-ok' : '<div class="muted">R√©seau OK ‚Üí passer au diagnostic Mat√©riel.</div>',
  'net-ko' : '<ul><li>V√©rifier PoE / lien</li><li>Adressage IP / VLAN</li><li>Switch / SFP / jarreti√®re</li></ul>',
  'hw-ok'  : '<div class="muted">Mat√©riel OK ‚Üí si toujours panne, revoir r√©seau/alimentation.</div>',
  'hw-ko'  : '<ul><li>Tester avec cam√©ra de secours</li><li>Reset / firmware</li><li>Oxydation / connecteurs</li><li>Si panne confirm√©e ‚Üí RMA ou Devis</li></ul>'
};
function mountBranch(containerId, key){
  const el = qs(containerId);
  if(!el) return;
  el.innerHTML = '<details open><summary>Chemin choisi</summary>' + branchTexts[key] + '</details>';
}
qsa('[data-branch]').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-branch');
    if(key.startsWith('alim')) mountBranch('#alim-branches', key);
    if(key.startsWith('net'))  mountBranch('#net-branches', key);
    if(key.startsWith('hw'))   mountBranch('#hw-branches', key);
  });
});


// ---------- Report export ----------
const __exp = qs('#exportBtn'); if(__exp){ __exp.addEventListener('click', () => {
  const lines = [];
  const date = new Date().toLocaleString('fr-FR');
  lines.push('Rapport de d√©pannage ‚Äî ' + date);
  lines.push('');
  lines.push('Checklist:');
  checklistKeys.forEach(k => lines.push(`- ${k}: ${checklist[k] ? 'OK' : 'NON'}`));
  lines.push('');
  lines.push('Journal assistant guid√©:');
  const log = load('fusion_reportLog', []);
  log.forEach(l => lines.push(l));
  lines.push('');
  lines.push('Compte-rendu:');
  lines.push(qs('#cr').value || '(vide)');
  const text = lines.join('\n');
  const pre = qs('#export');
  pre.textContent = text;
  pre.classList.remove('hidden');
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'rapport_depannage.txt';
  a.click();
  URL.revokeObjectURL(url);
}); }

// =====================================================
// ============== Wizard (Dep3 am√©lior√©) ===============
// =====================================================
let fusion_reportLog = load('fusion_reportLog', []);
function logStep(text) {
  const timestamp = new Date().toLocaleTimeString('fr-FR');
  fusion_reportLog.push(`${timestamp} - ${text}`);
  store('fusion_reportLog', fusion_reportLog);
}

const diagSteps = {
  alim_main: {
    start: {
      title: 'Alimentation',
      text: 'Quel est le type d\'alimentation ?',
      answers: [
        { text: '230V', next: 'start', flow: 'alim_230v' },
        { text: 'Batterie / EP', next: 'start', flow: 'alim_batt' },
        { text: 'Panneaux Solaires', next: 'start', flow: 'alim_solar' }
      ]
    }
  },
  alim_230v: {
    start: {
      title: 'Alim 230V',
      text: 'V√©rifier le disjoncteur √©lectrique. Est-il enclench√© ?',
      answers: [
        { text: 'Oui', next: 'tension_sortie' },
        { text: 'Non', next: 'reenclencher' }
      ]
    },
    reenclencher: {
      text: 'R√©-enclencher le disjoncteur. Tient-il ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Surcharge ponctuelle. Probl√®me r√©solu.' },
        { text: 'Non', conclusion: 'KO - Court-circuit sur la ligne ou l\'√©quipement.' }
      ]
    },
    tension_sortie: {
      text: 'Mesurer la tension en sortie du disjoncteur. Tension de 230V pr√©sente ?',
      answers: [
        { text: 'Oui', next: 'tension_equip' },
        { text: 'Non', conclusion: 'KO - Probl√®me en amont du disjoncteur (r√©seau).' }
      ]
    },
    tension_equip: {
      text: 'Tension pr√©sente sur l\'√©quipement ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - L\'alimentation est OK. Le probl√®me n\'est pas √©lectrique.' },
        { text: 'Non', conclusion: 'KO - Probl√®me sur le c√¢ble ou mauvaise connexion.' }
      ]
    }
  },
  alim_batt: {
    start: {
      title: 'Alim Batterie',
      text: 'Mesurer la tension aux bornes de la batterie. Tension correcte (12V/24V) ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - L\'alimentation est OK. Le probl√®me n\'est pas √©lectrique.' },
        { text: 'Non', next: 'disj' }
      ]
    },
    disj: {
      text: 'V√©rifier Disjoncteur EP / Parafoudre. Quel est l\'√©tat ?',
      answers: [
        { text: 'OK', next: 'rechange_dispo' },
        { text: 'KO', conclusion: 'KO - Disjoncteur/Parafoudre √† remplacer.' }
      ]
    },
    rechange_dispo: {
      text: 'Batterie de rechange disponible dans le v√©hicule ?',
      answers: [
        { text: 'Oui', next: 'remplacer' },
        { text: 'Non', conclusion: 'KO - Pr√©voir nouvelle intervention (pas de batterie).' }
      ]
    },
    remplacer: {
      text: 'Remplacer par une batterie pleine. Le chargeur fonctionne bien ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Probl√®me r√©solu (batterie remplac√©e).' },
        { text: 'Non', conclusion: 'KO - Probl√®me du Pack, RMA √† pr√©voir.' }
      ]
    }
  },
  alim_solar: {
    start: {
      title: 'Alim Solaire',
      text: 'Mesurer la tension aux bornes de la batterie. Tension correcte (~12V) ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Le syst√®me solaire est OK.' },
        { text: 'Non', next: 'panneaux' }
      ]
    },
    panneaux: {
      text: 'V√©rifier la tension en sortie des panneaux (en plein soleil). Correcte (>17V) ?',
      answers: [
        { text: 'Oui', next: 'regulateur' },
        { text: 'Non', conclusion: 'KO - Probl√®me sur les panneaux (propret√©, ombrage, panne).' }
      ]
    },
    regulateur: {
      text: 'V√©rifier le r√©gulateur de charge. Fonctionne-t-il correctement ?',
      answers: [
        { text: 'Oui', conclusion: 'KO - La batterie est HS et n\'accepte plus la charge.' },
        { text: 'Non', conclusion: 'KO - R√©gulateur de charge d√©fectueux. Remplacement n√©cessaire.' }
      ]
    }
  },
  net: {
    start: {
      title: 'R√©seau',
      text: 'Le lien r√©seau (Switch, PoE) est-il actif ?',
      answers: [
        { text: 'Oui', next: 'ping' },
        { text: 'Non', conclusion: 'KO - Pas de lien physique. V√©rifier c√¢blage, switch, PoE.' }
      ]
    },
    ping: {
      text: 'La cam√©ra r√©pond-elle au ping ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - La connectivit√© r√©seau semble OK.' },
        { text: 'Non', conclusion: 'KO - Probl√®me de configuration IP, VLAN ou pare-feu.' }
      ]
    }
  },
  hw: {
    start: {
      title: 'Mat√©riel',
      text: 'Tester la cam√©ra en local. Fonctionne-t-elle ?',
      answers: [
        { text: 'Oui', conclusion: 'OK - Le probl√®me n\'est pas la cam√©ra. Re-v√©rifier Alim/R√©seau.' },
        { text: 'Non', conclusion: 'KO - Probl√®me sur la cam√©ra, RMA ou devis √† pr√©voir si le probl√®me n\'est pas r√©solu suite √† la r√©initialisation.' }
      ]
    }
  }
};

const wizardOverlay = qs('#wizard-overlay');
const wizardTitle = qs('#wizard-title');
const wizardText  = qs('#wizard-text');
const wizardAnswers = qs('#wizard-answers');
const wizardClose = qs('#wizard-close');

let currentFlow = null;
let currentFlowKey = null;

function startWizard(flowKey) {
  currentFlowKey = flowKey;
  currentFlow = diagSteps[flowKey];
  if (!currentFlow || !currentFlow.start) {
    console.error('Diagnostic flow not found or invalid:', flowKey);
    return;
  }
  wizardTitle.textContent = currentFlow.start.title || 'Diagnostic';
  wizardText.textContent = currentFlow.start.text || '...';
  wizardAnswers.innerHTML = '';
  wizardOverlay.classList.remove('hidden');
  logStep(`DEBUT Diagnostic: ${wizardTitle.textContent}`);
  setTimeout(() => renderStep('start'), 0);
}

function renderStep(stepKey) {
  const step = currentFlow[stepKey];
  if (!step) {
    console.error('Step not found:', stepKey, 'in', currentFlowKey);
    wizardText.textContent = '√âtape introuvable.';
    wizardAnswers.innerHTML = '<button class="pill" onclick="endWizard()">Fermer</button>';
    return;
  }
  wizardTitle.textContent = step.title || currentFlow.start.title || 'Diagnostic';
  wizardText.textContent  = step.text || step.conclusion || '';
  wizardAnswers.innerHTML = '';

  if (step.answers && step.answers.length) {
    step.answers.forEach(answer => {
      const btn = document.createElement('button');
      btn.textContent = answer.text;
      btn.className = 'pill';
      btn.onclick = () => {
        logStep(`${wizardText.textContent} -> ${answer.text}`);
        if (answer.flow) {
          currentFlowKey = answer.flow;
          currentFlow = diagSteps[answer.flow];
        }
        if (answer.next) {
            renderStep(answer.next);
        } else if (answer.conclusion) {
            renderConclusion(answer);
        } else {
            renderConclusion({ conclusion: 'Fin.' });
        }
      };
      wizardAnswers.appendChild(btn);
    });
  } else if (step.conclusion) {
    renderConclusion(step);
  } else {
    const btn = document.createElement('button');
    btn.textContent = 'Continuer';
    btn.className = 'pill';
    btn.onclick = endWizard;
    wizardAnswers.appendChild(btn);
  }
}

function renderConclusion(step) {
  wizardText.textContent = step.conclusion;
  wizardAnswers.innerHTML = '';
  const btn = document.createElement('button');
  btn.textContent = 'Terminer';
  btn.className = 'pill ok';
  btn.onclick = () => {
    logStep(`CONCLUSION: ${step.conclusion}`);
    endWizard();
  };
  wizardAnswers.appendChild(btn);
}

function endWizard() {
  wizardOverlay.classList.add('hidden');
  currentFlow = null;
  currentFlowKey = null;
}

wizardClose.addEventListener('click', endWizard);

// Triggers
qs('#startAlimDiag').addEventListener('click', () => startWizard('alim_main'));
qs('#startNetDiag').addEventListener('click',  () => startWizard('net'));
qs('#startHwDiag').addEventListener('click',   () => startWizard('hw'));

</script>
<script>
(function(){
  var btn = document.getElementById('fsLink');
  var url = 'https://fredericlacherade-ctrl.github.io/guide-camera/'; // ton URL directe
  if (window.self !== window.top) { // embarqu√© (Google Sites)
    btn.href = url;
    btn.target = '_blank'; // ou '_top' si tu veux remplacer l‚Äôonglet
  } else {
    btn.style.display = 'none'; // d√©j√† en plein √©cran ‚Üí cacher le bouton
  }
})();
</script>

</body>
</html>
